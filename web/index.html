<body>
    <div class="header">
        &HEADERLEFTBUTTON
        <p class="headerTextLeft">&TITLEUSERNAME</p>
    </div>
    <div id="notifications"></div>
    <div id="sideMenu" class="headerSideList" style="margin-left: -100%;">
        <div class="headerSideListButton">
            <p class="headerSideListButtonText">Profile</p>
        </div>
        <div class="headerSideListButton">
            <p class="headerSideListButtonText">Friends</p>
        </div>
        <div class="headerSideListButton">
            <p class="headerSideListButtonText">Search</p>
        </div>
        <div class="headerSideListButton">
            <p class="headerSideListButtonText">Settings</p>
        </div>
        <div onclick="logout();" class="headerSideListButton">
            <p class="headerSideListButtonText">Log Out</p>
        </div>
    </div>
    <div onclick="closeSideMenu();" id="headerSideListBackground" class="headerSideListBackground" style="transition: 0.4s;display: none;background-color: rgba(0, 0, 0, 0);"></div>

    <div id="chatScroll" class="chatLog">
        <div id="chat" class="chatLogHistory"><div id="chat" class="chatLogHistory">
            <h2 id="welcomeText" style="color: white;text-align: center;display: none;">Welcome @&YOURUSERNAME</h2>
            <p class="messageHistoryTitle">Message history with @&TITLEUSERNAME begins here.</p><hr>&MESSAGEHISTORYSTARTSHERE<div id="chatUsersList">&USERSLIST</div><p id="sendStatus" class="bubbleSent" style="display: none;">Sent</p>
        </div>
    </div>

    <div id="emojiList" class="emojiList" style="display: none;">
        <h2>Emoji</h2>
        <div class="emojiListGrid">
            <div id="emojiListContent" class="emojiListContent">
                
            </div>
        </div>
    </div>

    <div class="footer">
        <a onclick="emojiOpen();" class="footerLeftButton">
            <div style="background-image: url(../img/Emojis.svg);background-position: center;background-size: contain;width: 100%;height: 100%;"></div>
        </a>
        <textarea id="messageField" class="inputArea" placeholder="Message" maxlength="500"></textarea>
        <a onclick="sendMessage();" class="footerSend buttonRound"><div style="background-image: url(../img/SendArrow.svg);background-position: center;background-size: contain;width: 100%;height: 100%;"></div></a>
    </div>

    <script>
        var menuOpen = false;

        function openSideMenu() {
            var sideMenu = document.getElementById("sideMenu");

            if (menuOpen == false)
            {
                sideMenu.style.marginLeft = "0";
                document.getElementById("headerSideListBackground").style.display = "block";
                setTimeout(() => {
                    document.getElementById("headerSideListBackground").style.backgroundColor = "#000000b3";
                }, 10);
                menuOpen = true;
            }
            else
            {
                sideMenu.style.marginLeft = "-300px";
                document.getElementById("headerSideListBackground").style.backgroundColor = "#00000000";
                menuOpen = false;
                setTimeout(() => {
                    document.getElementById("headerSideListBackground").style.display = "none";
                }, 200);
            }
        }
        function closeSideMenu() {
            var sideMenu = document.getElementById("sideMenu");

            sideMenu.style.marginLeft = "-300px";
            document.getElementById("headerSideListBackground").style.backgroundColor = "#00000000";
            menuOpen = false;
            setTimeout(() => {
                document.getElementById("headerSideListBackground").style.display = "none";
            }, 200);
        }
    </script>

    <script>
        function logout() {
            document.cookie = "token=; path=/";
            window.location.href = "../signin";
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        const userListButton = `<a href="@&USERNAMELINK" id="user&UID" class="users">
            <div class="listUser">
                <p id="listUserName&UID" class="listUserName">&USERNAME</p>
            </div>
        </a>`;

        const notification = `<div id="notification&ID" class="notification">
            <span style="user-select: none;float: right;color: grey;top: 0;margin: 5px;cursor: pointer;" onclick="document.getElementById('notification&ID').outerHTML = '';">Dismiss</span>
            <a href="@&USERNAME">
                <h3>New message from &USERNAME</h3>
                <p>&MESSAGE</p>
            </a>
        </div>`;

        const theyBubble = "<div class=\"bubble bubbleLeft\">&MESSAGE</div>";
        const meBubble = "<div class=\"bubble bubbleRight\">&MESSAGE</div>";

        var xhr = null;
        var interval = null;

        var chatusername = (document.documentURI).split("@")[1];
        var token = getCookie("token");

        var socket = io();
        socket.emit('settoken', token);
        socket.on('message', receiveMessage);
        
        function count(obj) {
            var count=0;
            for(var prop in obj) {
                if (obj.hasOwnProperty(prop)) {
                    ++count;
                }
            }
            return count;
        }

        if ((document.documentURI).endsWith("@me", document.documentURI.length)) {
            document.getElementsByClassName("footer")[0].style.display = "none";
            document.getElementById("welcomeText").style.display = "block";
            //refreshusers();
        }
        /*else {
            requestmessages();
        }*/

        document.getElementById("emojiList").style.display = "none";

        var chatHeightEmoji = "calc(100% - 64px - 60px - 10px - 250px)";
        var footerBottomEmoji = "250px";

        var emojicontent = document.getElementById("emojiListContent");
        var emoji = `<div onclick="emoji('_');" id="_" class="emoji">EMOJIICON</div>`;

        function emojiclick(emojitag) {
            document.getElementById("messageField").value += document.getElementById(emojitag).innerText;
            document.getElementById("messageField").focus();
        }

        function emojiOpen() {
            var emojis = document.getElementById("emojiList");
            
            if (emojis.style.display == "none") {
                emojis.style.display = "";
            }
            else {
                emojis.style.display = "none";
            }

            $.ajax({
                url: "/emojis.txt",
                success: function (data){
                    emojicontent.innerHTML = data;
                }
            });
        }
        
        var dateString = "<p id=\"timestamp\" name=\"timestamp\" class=\"bubbleSent\" style=\"display: block;\">&MESSAGE</p>";
        var dateSplit = true;

        $(function() {
            $("#messageField").keypress(function (e) {
                if(e.which == 13 && e.shiftKey == false) {
                    sendMessage();
                    $("#chatbox").append($(this).val() + "<br/>");
                    $(this).val("");
                    e.preventDefault();
                }
            });
        });

        var chatScroll = document.getElementById("chatScroll");

        setTimeout(() => {  
            chatScroll.scrollTop = chatScroll.scrollHeight - chatScroll.clientHeight;
        }, 10);

        function receiveMessage(data)
        {
            var chatScroll = document.getElementById("chatScroll");
            var scroll = false;
            if (chatScroll.scrollTop == (chatScroll.scrollHeight - chatScroll.clientHeight)) {
                scroll = true;
            }

            if (data.from == chatusername) {
                var sendStatus = document.getElementById("sendStatus");
                sendStatus.innerText = "Seen";

                message = "";

                var htmlCode = theyBubble.replace("&MESSAGE", data.message);

                id = Math.floor((Math.random() * 999999) + 1);
                document.getElementById("chat").innerHTML += htmlCode;
                
                dateSplit = true;

                setTimeout(() => {  
                    if (scroll) {
                        chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                    }
                }, 100);
            }
            else {
                var msg = data.message;

                if (data.message.length > 50) {
                    msg = data.message.substring(0, 50) + "...";
                }

                id = Math.floor((Math.random() * 999999) + 1);

                var htmlCode = notification
                                .replace(/&ID/g, id)
                                .replace(/&USERNAME/g, data.from)
                                .replace(/&MESSAGE/g, msg);
                                
                var notifications = document.getElementById("notifications");

                const placeholder = document.createElement('div');
                placeholder.innerHTML = htmlCode;
                const node = placeholder.firstElementChild;

                notifications.insertBefore(node, notifications.firstChild);

                setTimeout(() => {  
                    if (scroll) {
                        chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                    }
                }, 100);

                notificated("notification" + id);
            }
        }

        function notificated(id) {
            document.getElementById(id).style.transition = "0.2s";
            document.getElementById(id).style.transform = "translateX(0px) translateY(-200px)";

            setTimeout(() => {  
                document.getElementById(id).style.transform = "translateX(0px) translateY(0px)";
            }, 10);

            setTimeout(() => {  
                
                document.getElementById(id).style.transform = "translateX(-350px) translateY(0px)";
                
                setTimeout(() => {  
                    document.getElementById(id).outerHTML = "";
                }, 200);

            }, 10000);
        }
        
        function sendMessage()
        {
            var sendStatus = document.getElementById("sendStatus");
            sendStatus.innerText = "Seen";

            message = "";

            var chatScroll = document.getElementById("chatScroll");
            var scroll = false;
            if (chatScroll.scrollTop == (chatScroll.scrollHeight - chatScroll.clientHeight)) {
                scroll = true;
            }

            document.getElementById("emojiList").style.display = "none";
            
            var msg = document.getElementById("messageField").value;

            messageField.value = "";

            socket.emit('message', chatusername, token, msg);

            var htmlCode = meBubble.replace("&MESSAGE", msg);
            document.getElementById("chat").innerHTML += htmlCode;

            setTimeout(() => {  
                if (scroll) {
                    chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                }
            }, 100);
        }

        function messageSentConfirm(message) {
            document.getElementById("sendStatus").style.display = "none";

            var chatScroll = document.getElementById("chatScroll");
            var scroll = false;
            if (chatScroll.scrollTop == (chatScroll.scrollHeight - chatScroll.clientHeight)) {
                scroll = true;
            }

            id = Math.floor((Math.random() * 999999) + 1);
            document.getElementById("chat").innerHTML += "<div id=\"chatBubble" + id + "\" class=\"bubble bubbleRight\">" + message + "</div>";
            
            if (scroll)
            {
                chatScroll.scrollTop = chatScroll.scrollHeight;
            }

            var sendStatus = document.getElementById("sendStatus");
            sendStatus.style.display = "block";
            sendStatus.parentNode.appendChild(sendStatus);

            if (scroll) {
                chatScroll.scrollTop = chatScroll.scrollHeight + 10;
            }
            
            if (dateSplit == false)
            {
                document.getElementsByName("timestamp").forEach(element => {
                    if (element.id != "")
                    {
                        element.style.display = "none";
                        element.id = "";
                    }
                });
            }
            else
            {
                document.getElementsByName("timestamp").forEach(element => {
                    if (element.id != "")
                    {
                        element.id = "";
                    }
                });
            }

            dateSplit = false;

            // DATE TIMESTAMP
            const today = new Date();
            var date = formatDate(today, 't');
            document.getElementById("chat").innerHTML += dateString.replace("&MESSAGE", date);
            
            if (scroll) {
                chatScroll.scrollTop = chatScroll.scrollHeight + 10;
            }
        }

        function formatDate(date, format) {
            const map = {
                mm: date.getMonth() + 1,
                dd: date.getDate(),
                yy: date.getFullYear().toString().slice(-2),
                yyyy: date.getFullYear(),
                t: date.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            }

            return format.replace(/mm|dd|yy|yyyy|t/gi, matched => map[matched])
        }
    </script>
</body>
