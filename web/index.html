<script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>

<body>
    <div id="disconnected" class="headerSideListBackground" style="display: none;transition: all 0.4s ease 0s;background-color: rgba(0, 0, 0, 0.7);z-index: 1000000;">
        <div class="disconnectedD">
            <h2 class="disconnectedH">Disconnected</h2>
            <hr>
            <p class="disconnectedT">Server closed.<br><br>Please refresh the page to try reconnecting...</p>
            <a href="/" class="disconnectedB">Reconnect</a>
            <a onclick="logout();" class="disconnectedB">Log Out</a>
        </div>
    </div>

    <div id="conencting" class="headerSideListBackground" style="
        user-select: none;
        transition: all 0.4s ease 0s;
        background-color: rgb(14 14 14);
        z-index: 1000000;
        right: 0;
        bottom: 0;
        top: 0;
        left: 0;
        position: fixed;
        filter: opacity(100%);
        transition: 0.5s;
    ">
        <div style="
            width: 300px;
            padding: 20px;
            margin: 0;
            background: rgb(29 29 29);
            display: flow-root;
            position: absolute;
            top: 50%;
            left: calc(50% - 170px);
            -ms-transform: translateX(50%) translateY(-50%);
            transform: translateX(calc(50% - 170px)) translateY(-50%);
        ">
            <img src="../img/app-loading.gif" width="100" style="margin: 0 auto;display: block;" draggable="false">
            <h2 style="margin: 0;text-align: center;">
                Connecting
            </h2>
            <p id="connectionProblems" style="text-align: center;display: none;">
                Connection problems? Let us know!
                <span style="margin-top: 16px;display: block;">Discord 
                    <span id="copyHelpDC" onclick="CopyToClipboard('copyHelpDC');" style="
                        cursor: pointer;
                        user-select: all;
                        background-color: rgb(0 0 0 / 45%);
                        padding: 5px;
                        border-radius: 10px;
                        margin-right: 10px;
                    "><span class="copyBubble" style="display: none;">Copied!</span>Mara#2222</span> 
                    <a href="https://github.com/Marakusa/NeoChat/issues" target="_blank" style="cursor: pointer;text-decoration-line: underline;">
                        GitHub
                    </a>
                </span>
            </p>
        </div>
    </div>
    
    <div class="header">
        &HEADERLEFTBUTTON
        <p class="headerTextLeft">&TITLEUSERNAME</p>
    </div>
    <div id="notifications"></div>
    <div id="sideMenu" class="headerSideList" style="margin-left: -100%;">
        <div class="userListContent" style="display: block;">
            <div name="chatUsersList" style="
                width: 230px;
                height: calc(100% - 10px);
                float: left;
                display: block;
                font-size: 24px;
                color: rgb(0 0 0);
                position: absolute;
                overflow-x: hidden;
                overflow-y: auto;
                padding: 5px;
                bottom: 0;
                right: 0;
                left: 0;
                top: 0;
                background-color: rgb(28 28 28);
                z-index: 5;
            ">

            </div>
        </div>
    </div>
    <div onclick="closeSideMenu();" id="headerSideListBackground" class="headerSideListBackground" style="transition: 0.4s;display: none;background-color: rgba(0, 0, 0, 0);"></div>
    
    <div class="mainContent">
        <div class="userListContent">
            <div name="chatUsersList">

            </div>
        </div>
        <div id="chatScroll" class="chatLogDevice chatLog">
            <div id="chat" class="chatLogHistory">
                
            </div>
        </div>
    </div>
    
    <div class="footer">
        <div id="emojiList" class="emojiList" style="display: none;">
            <h2>Emoji</h2>
            <div class="emojiListGrid">
                <div id="emojiListContent" class="emojiListContent">
                    
                </div>
            </div>
        </div>
        
        <div onclick="chatScroll.scrollTop = chatScroll.scrollHeight - chatScroll.clientHeight;" class="newMessage">
            <span>You have unread messages</span>
        </div>
        <a onclick="emojiOpen();" class="footerLeftButton">
            <div style="background-image: url(../img/icon-emojis.svg);background-position: center;background-size: contain;width: 100%;height: 100%;"></div>
        </a>
        <textarea id="messageField" class="inputArea" placeholder="Message" maxlength="500" hidden></textarea>
        <span aria-label="Message" aria-multiline="true" data-can-focus="true" data-slate-editor="true" contenteditable="true" autocorrect="off" spellcheck="true" role="textbox" data-gramm="false" id="messageFieldSpan" class="inputArea" for="messageField" contenteditable></span>
        <a onclick="sendMessage();" class="footerSend buttonRound"><div style="background-image: url(../img/send-arrow.svg);background-position: center;background-size: contain;width: 100%;height: 100%;"></div></a>
    </div>
    
    <div id="contextList" class="contextList" style="transform: translate(0px, 0px);display: none;">
        <p onclick="console.log('copy');">Copy</p>
        <p onclick="console.log('share');">Share</p>
        <hr>
        <p onclick="console.log('profile');">User Profile</p>
    </div>
    
    <script>
        var menuOpen = false;
    
        function openSideMenu() {
            var sideMenu = document.getElementById("sideMenu");
    
            if (menuOpen == false)
            {
                sideMenu.style.marginLeft = "0";
                document.getElementById("headerSideListBackground").style.display = "block";
                setTimeout(() => {
                    document.getElementById("headerSideListBackground").style.backgroundColor = "#000000b3";
                }, 10);
                menuOpen = true;
            }
            else
            {
                sideMenu.style.marginLeft = "-300px";
                document.getElementById("headerSideListBackground").style.backgroundColor = "#00000000";
                menuOpen = false;
                setTimeout(() => {
                    document.getElementById("headerSideListBackground").style.display = "none";
                }, 200);
            }
        }
        function closeSideMenu() {
            var sideMenu = document.getElementById("sideMenu");
    
            sideMenu.style.marginLeft = "-300px";
            document.getElementById("headerSideListBackground").style.backgroundColor = "#00000000";
            menuOpen = false;
            setTimeout(() => {
                document.getElementById("headerSideListBackground").style.display = "none";
            }, 200);
        }
    </script>
    
    <script>
        setTimeout(function () {
            document.getElementById("connectionProblems").style.display = "block";
        }, 10000);
        
        function CopyToClipboard(containerid) {
            if (document.selection) {
                var range = document.body.createTextRange();
                range.moveToElementText(document.getElementById(containerid));
                range.select().createTextRange();
                document.execCommand("copy");

                document.getElementById(containerid).childNodes[0].style.display = "inline";

                if (window.getSelection) {window.getSelection().removeAllRanges();}
                else if (document.selection) {document.selection.empty();}
                
                setTimeout(function () {
                    document.getElementById(containerid).childNodes[0].style.display = "none";
                }, 3000);
            } else if (window.getSelection) {
                var range = document.createRange();
                range.selectNode(document.getElementById(containerid));
                window.getSelection().addRange(range);
                document.execCommand("copy");

                document.getElementById(containerid).childNodes[0].style.display = "inline";

                if (window.getSelection) {window.getSelection().removeAllRanges();}
                else if (document.selection) {document.selection.empty();}
                
                setTimeout(function () {
                    document.getElementById(containerid).childNodes[0].style.display = "none";
                }, 3000);
            }
        }

        var emojis = new Array();

        // ALL EMOJIS
        // https://gist.githubusercontent.com/oliveratgithub/0bf11a9aff0d6da7b46f1490f86a71eb/raw/d8e4b78cfe66862cf3809443c1dba017f37b61db/emojis.json

        const clamp = (num, min, max) => Math.min(Math.max(num, min), max);
    
        document.body.addEventListener('click', function () { document.getElementById("contextList").style.display = "none"; }, true);
        document.body.addEventListener('scroll', function () { document.getElementById("contextList").style.display = "none"; }, true);

        function getMobileOperatingSystem() {
            var userAgent = navigator.userAgent || navigator.vendor || window.opera;
    
            // Windows Phone must come first because its UA also contains "Android"
            if (/windows phone/i.test(userAgent)) {
                return "winphone";
            }
    
            if (/android/i.test(userAgent)) {
                return "android";
            }
    
            // iOS detection from: http://stackoverflow.com/a/9039885/177710
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                return "ios";
            }
    
            return "";
        }
    
        function applyAfterResize() {
            if (getMobileOperatingSystem() != '') {
                chatScroll.scrollTop = chatScroll.scrollHeight + 10;
            }
        }
    
        $(window).on('resize orientationchange', function(){
            applyAfterResize();
        });
    
        function logout() {
            document.cookie = "token=; path=/";
            window.location.href = "../signin";
        }
    
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    
        const userListButton = `<a href="@&USERNAMELINK" id="user&UID" class="users">
            <div class="listUser">
                <p id="listUserName&UID" class="listUserName">&USERNAME</p>
            </div>
        </a>`;
    
        const notification = `<div id="notification&ID" class="notification">
            <span style="user-select: none;float: right;color: grey;top: 0;margin: 5px;cursor: pointer;" onclick="document.getElementById('notification&ID').outerHTML = '';">Dismiss</span>
            <a href="@&USERNAME">
                <h3>New message from &USERNAME</h3>
                <p>&MESSAGE</p>
            </a>
        </div>`;
    
        const theyBubble = "<div id=\"bubble&ID\" class=\"bubble bubbleLeft\">&MESSAGE</div>";
        const meBubble = "<div id=\"bubble&ID\" class=\"bubble bubbleRight\">&MESSAGE</div>";
    
        var xhr = null;
        var interval = null;
    
        var chatusername = "";
        var token = getCookie("token");
    
        var socket = io();
        socket.emit('settoken', token);
        socket.emit('getpage', document.documentURI.replace(/^[^#]*?:\/\/.*?\//, "/"), token);
        socket.on('message', receiveMessage);
        socket.on('page', pageLoad);
        socket.on('userlist', getUserList);
    
        socket.on('userstatus', receiveUserStatus);
        
        function count(obj) {
            var count=0;
            for(var prop in obj) {
                if (obj.hasOwnProperty(prop)) {
                    ++count;
                }
            }
            return count;
        }
        
        var mepage = false;
    
        var idleTime = 0;
        $(document).ready(function () {
            // Increment the idle time counter every minute.
            var idleInterval = setInterval(timerIncrement, 60000); // 1 minute
    
            $(this).mousemove(function (e) {
                idleTime = 0;
                socket.emit('setuserstatus', 1, token);
            });
            $(this).click(function (e) {
                idleTime = 0;
                socket.emit('setuserstatus', 1, token);
            });
            $(this).keypress(function (e) {
                idleTime = 0;
                socket.emit('setuserstatus', 1, token);
            });
        });
    
        function timerIncrement() {
            idleTime = idleTime + 1;
            if (idleTime > 9) { // afk for over 10 minutes
                socket.emit('setuserstatus', 2, token);
            }
        }
    
        function receiveUserStatus(data) {
            if (document.getElementById('listUserName' + data.user)) {
                var user = document.getElementById('listUserName' + data.user);
                user.childNodes[0].classList.remove("userStatus1");
                user.childNodes[0].classList.remove("userStatus2");
                user.childNodes[0].classList.remove("userStatus3");
                
                if (user.childNodes[0].classList.contains("userStatus0") == true || data.status == "0") {
                    user.childNodes[0].classList.add("userStatus" + data.status);
                }
                //user.innerHTML = "<span class=\"userStatus" + data.status + "\"></span>" + user.innerHTML.split("</span>")[1];
            }
        }
    
        document.getElementById("emojiList").style.display = "none";
    
        var chatHeightEmoji = "calc(100% - 64px - 60px - 10px - 250px)";
        var footerBottomEmoji = "250px";
    
        var emojicontent = document.getElementById("emojiListContent");
        var emoji = `<div onclick="emoji('_');" id="_" class="emoji">EMOJIICON</div>`;
    
        function emojiclick(emojitag) {
            document.getElementById("messageFieldSpan").innerText += document.getElementById(emojitag).id;
            document.getElementById("messageFieldSpan").focus();
        }
    
        function emojiOpen() {
            var emojis = document.getElementById("emojiList");
            
            if (emojis.style.display == "none") {
                emojis.style.display = "";
            }
            else {
                emojis.style.display = "none";
            }
    
            if (emojicontent.innerHTML.trim() == "") {
                $.ajax({
                    url: "/data/emojis.txt",
                    success: function (data){
                        emojicontent.innerHTML = data;
                    }
                });
            }
        }
        
        var dateString = "<p id=\"timestamp\" name=\"timestamp\" class=\"bubbleSent\" style=\"display: block;\">&MESSAGE</p>";
        var dateSplit = true;
    
        $(function() {
            $("#messageFieldSpan").keypress(function (e) {
                if(e.which == 13 && e.shiftKey == false) {
                    sendMessage();
                    //$("#chatbox").append($(this).val() + "<br/>");
                    //$(this).val("");
                    e.preventDefault();
                }
            });
        });

        //const twemoji = "<span contenteditable=\"false\"><span class=\"twa twa-&ID\" src=\"\" aria-label=\"&ID\" draggable=\"false\" contenteditable=\"false\"></span></span> ";

        $("#messageFieldSpan").on('keyup paste', function(e) {
            /*var newText = twemoji.parse(document.getElementById("messageFieldSpan").innerHTML);
            console.log(newText);
            document.getElementById("messageFieldSpan").innerHTML = newText;

            if (e.target.innerHTML.length > 500) {
                e.target.innerHTML = e.target.innerHTML.substring(0, 500);
            }

            var emojiarray = new Array(e.target.innerText.match(/:[^:\s]*(?:::[^:\s])*:/g));
            if (emojiarray[0] != null) {
                for (var i = 0; i < emojiarray[0].length; i++) {
                    e.target.innerHTML = e.target.innerHTML.replace(emojiarray[0][i], twemoji.replace(/&ID/g, emojiarray[0][i].replace(/:/g, "").replace(/_/g, "-")));
                }
            }*/
        });
    
        var chatScroll = null;
        var newMessage = null;

        const headerBackButton = "<a href=\"@me\" id=\"headerBack\" class=\"headerBack buttonRound\"><div style=\"background-image: url(../img/back-arrow.svg);background-position: center;background-size: contain;width: 100%;height: 100%;\"></div></a>";
        const headerMenuButton = "<a onclick=\"openSideMenu();\" class=\"headerBack buttonRound\"><div style=\"background-image: url(../img/menu-lines.svg);background-position: center;background-size: contain;width: 100%;height: 100%;\"></div></a>";
        const headerText = "<p class=\"headerTextLeft\">&TITLE</p>";

        var lastchatusername = "";

        setInterval(function () {
            
            var last = document.getElementsByName("user" + lastchatusername.toLowerCase());
            var recent = document.getElementsByName("user" + (document.documentURI).split("@")[1].toLowerCase());

            if (last.length > 0) {
                if (last[0].classList.contains("selectedUser") == true) {
                    last[0].classList.remove("selectedUser");
                }
                if (last[1].classList.contains("selectedUser") == true) {
                    last[1].classList.remove("selectedUser");
                }
            }
            if (recent.length > 0) {
                if (recent[0].classList.contains("selectedUser") == false) {
                    recent[0].classList.add("selectedUser");
                }
                if (recent[1].classList.contains("selectedUser") == false) {
                    recent[1].classList.add("selectedUser");
                }
            }

            lastchatusername = (document.documentURI).split("@")[1].toLowerCase();
            
        }, 100);

        // Load page
        function pageLoad(code, data, chatUserId, chatUser) {
            console.log(data);
            document.getElementById("chat").innerHTML = data;

            chatusername = (document.documentURI).split("@")[1];

            mepage = (document.documentURI).endsWith("@me", document.documentURI.length);
            ppage = (document.documentURI).endsWith("@p", document.documentURI.length);

            var header = document.getElementsByClassName("header")[0];
        
            if (mepage == true) {
                document.getElementsByClassName("footer")[0].style.display = "none";
                //document.getElementById("welcomeText").style.display = "block";
                header.innerHTML = headerMenuButton + headerText.replace(/&TITLE/g, "NeoChat");
                //if (document.getElementById("messageHistoryTitle")) {
                //    document.getElementById("messageHistoryTitle").innerText = "Here is your friends list.";
                //}
            }
            else if (ppage == true) {
                document.getElementsByClassName("footer")[0].style.display = "";
                //header.innerHTML = headerMenuButton + headerText.replace(/&TITLE/g, "NeoChat");
            }
            else {
                document.getElementsByClassName("footer")[0].style.display = "";
                //document.getElementById("welcomeText").style.display = "none";
                header.innerHTML = headerMenuButton + headerText.replace(/&TITLE/g, chatUser);

                var allBubbles = document.getElementsByClassName('bubble');
                for (var i=0, len=allBubbles.length|0; i<len; i=i+1|0) {
                    allBubbles[i].addEventListener('contextmenu', function (ev) { contextList(ev); }, false);
                }
            }
            
            chatScroll = document.getElementById("chatScroll");
            newMessage = document.getElementsByClassName("newMessage")[0];
            newMessage.style.display = "none";
        
            if (mepage == false) {
                setTimeout(() => {
                    chatScroll.scrollTop = chatScroll.scrollHeight - chatScroll.clientHeight;
                }, 10);
        
                setInterval(() => {
                    if (Math.round(chatScroll.scrollTop) >= Math.round(chatScroll.scrollHeight - chatScroll.clientHeight)) {
                        newMessage.style.display = "none";
                        document.title = "NeoChat";
                    }
                }, 100);
            }
            
            document.getElementById("conencting").style.filter = "opacity(0%)";
            setTimeout(() => {
                document.getElementById("conencting").style.display = "none";
            }, 500);
            
            var allBubbles = document.getElementsByClassName('bubble');
            for (var i=0, len=allBubbles.length|0; i<len; i=i+1|0) {
                allBubbles[i].addEventListener('contextmenu', function (ev) { contextList(ev); }, false);
            }
            
            setInterval(function () {
                if (socket.connected == false) {
                    document.getElementById("disconnected").style.display = "";
                    socket.emit('disconnect');
                    socket = null;
                }
            }, 1000);

            socket.emit('getuserlist', token);
        }
        function getUserList(code, data) {
            document.getElementsByName("chatUsersList")[0].innerHTML = data;
            document.getElementsByName("chatUsersList")[1].innerHTML = data;
            
            $(document).ready(function() {
                $('.users').off();
                $('#headerBack').off();
                $('.users').click(function() {
                    console.log("click");
                    sideMenu.style.marginLeft = "-300px";
                    document.getElementById("headerSideListBackground").style.backgroundColor = "#00000000";
                    menuOpen = false;
                    setTimeout(() => {
                        document.getElementById("headerSideListBackground").style.display = "none";
                    }, 200);

                    socket.emit('getpage', $(this)[0].href.replace(/^[^#]*?:\/\/.*?\//, "/"), token);
                    window.history.pushState({"html": document.outerHTML, "pageTitle": document.title},"", $(this)[0].href);

                    clickAssigned = true;

                    return false;
                });
                $('#headerBack').click(function() {
                    socket.emit('getpage', $(this)[0].href.replace(/^[^#]*?:\/\/.*?\//, "/"), token);
                    window.history.pushState({"html": document.outerHTML, "pageTitle": document.title},"", $(this)[0].href);

                    clickAssigned = true;

                    return false;
                });
            });
        }
        function receiveMessage(data) {
            var chatScroll = document.getElementById("chatScroll");
            var scroll = false;
            
            if (Math.round(chatScroll.scrollTop) >= Math.round(chatScroll.scrollHeight - chatScroll.clientHeight)) {
                scroll = true;
            }
    
            if (data.from == chatusername) {
                var sendStatus = document.getElementById("sendStatus");
                sendStatus.innerText = "Seen";
    
                message = "";
    
                id = Math.floor((Math.random() * 999999) + 1);
                var htmlCode = theyBubble.replace("&MESSAGE", data.message).replace("&ID", id);
    
                document.getElementById("chat").innerHTML += htmlCode;
    
                document.getElementById("bubble" + id).addEventListener('contextmenu', function (ev) { contextList(ev); }, false);
                
                dateSplit = true;
    
                if (mepage == false) {
                    setTimeout(() => {  
                        if (scroll && document[hidden] == false) {
                            chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                            document.title = "NeoChat";
                        }
                        else {
                            playPing();
                            newMessage.style.display = "";
                        }
                    }, 100);
                }
                else {
                    playPing();
                }
            }
            else {
                playPing();
    
                var msg = data.message;
    
                if (data.message.length > 50) {
                    msg = data.message.substring(0, 50) + "...";
                }
    
                id = Math.floor((Math.random() * 999999) + 1);
    
                var htmlCode = notification
                                .replace(/&ID/g, id)
                                .replace(/&USERNAME/g, data.from)
                                .replace(/&MESSAGE/g, msg);
                                
                var notifications = document.getElementById("notifications");
    
                const placeholder = document.createElement('div');
                placeholder.innerHTML = htmlCode;
                const node = placeholder.firstElementChild;
    
                notifications.insertBefore(node, notifications.firstChild);
    
                if (mepage == false) {
                    setTimeout(() => {  
                        if (scroll) {
                            chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                            document.title = "NeoChat";
                        }
                        else {
                            newMessage.style.display = "";
                        }
                    }, 100);
                }
    
                notificated("notification" + id);
            }
        }
    
        function playPing() {
            setTimeout(function () {
                var mp3Source = '<source src="/sounds/ping.mp3" type="audio/mpeg">';
                var embedSource = '<embed hidden="true" autostart="true" loop="false" src="/sounds/ping.mp3">';
                document.getElementById("sound").innerHTML = '<audio autoplay="autoplay">' + mp3Source + embedSource + '</audio>';
    
                var audio = document.getElementById("sound").childNodes[0];
    
                if (getMobileOperatingSystem() == '') {
                    audio.volume = 0.2;
                }
    
                document.title = "(1) NeoChat";
            }, 100);
    
            /*var sound = new Audio({
                src: ['/sounds/ping.wav'],
                autoplay: true,
                loop: false,
                muted: true
            });
            sound.play();*/
        }
    
        function notificated(id) {
            document.getElementById(id).style.transition = "0.2s";
            document.getElementById(id).style.transform = "translateX(0px) translateY(-200px)";
    
            setTimeout(() => {  
                document.getElementById(id).style.transform = "translateX(0px) translateY(0px)";
            }, 10);
    
            setTimeout(() => {  
                
                document.getElementById(id).style.transform = "translateX(-350px) translateY(0px)";
                
                setTimeout(() => {  
                    document.getElementById(id).outerHTML = "";
                }, 200);
    
            }, 10000);
        }
        
        function sendMessage()
        {
            document.getElementById("messageField").value = document.getElementById("messageFieldSpan").innerHTML;
            document.getElementById("messageFieldSpan").focus();
    
            var sendStatus = document.getElementById("sendStatus");
            sendStatus.innerText = "Seen";
    
            message = "";
    
            var chatScroll = document.getElementById("chatScroll");
            var scroll = false;
            if (Math.round(chatScroll.scrollTop) >= Math.round(chatScroll.scrollHeight - chatScroll.clientHeight)) {
                scroll = true;
            }
    
            document.getElementById("emojiList").style.display = "none";
            
            var msg = document.getElementById("messageField").value;
    
            messageField.value = "";
    
            if (msg.length <= 500 && msg.trim() !== "") {
                socket.emit('message', chatusername, token, msg);
                
                /*var emojiarray = new Array(msg.match(/:[^:\s]*(?:::[^:\s])*:/g));
                if (emojiarray[0] != null) {
                    for (var i = 0; i < emojiarray[0].length; i++) {
                        msg = msg.replace(emojiarray[0][i], findEmoji(emojiarray[0][i]));
                    }
                }*/
                
                id = Math.floor((Math.random() * 999999) + 1);
                var htmlCode = meBubble.replace("&MESSAGE", msg).replace("&ID", id);
                document.getElementById("chat").innerHTML += htmlCode;
    
                document.getElementById("bubble" + id).addEventListener('contextmenu', function (ev) { contextList(ev); }, false);
                
                setTimeout(() => {  
                    if (scroll) {
                        chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                    }
                }, 100);
            }

            document.getElementById("messageField").value = "";
            document.getElementById("messageFieldSpan").innerHTML = "";
        }
    
        function messageSentConfirm(message) {
            document.getElementById("sendStatus").style.display = "none";
    
            var chatScroll = document.getElementById("chatScroll");
            var scroll = false;
            if (Math.round(chatScroll.scrollTop) >= Math.round(chatScroll.scrollHeight - chatScroll.clientHeight)) {
                scroll = true;
            }
    
            id = Math.floor((Math.random() * 999999) + 1);
            document.getElementById("chat").innerHTML += "<div id=\"chatBubble" + id + "\" class=\"bubble bubbleRight\">" + message + "</div>";
            
            var sendStatus = document.getElementById("sendStatus");
            sendStatus.style.display = "block";
            sendStatus.parentNode.appendChild(sendStatus);
    
            if (dateSplit == false)
            {
                document.getElementsByName("timestamp").forEach(element => {
                    if (element.id != "")
                    {
                        element.style.display = "none";
                        element.id = "";
                    }
                });
            }
            else
            {
                document.getElementsByName("timestamp").forEach(element => {
                    if (element.id != "")
                    {
                        element.id = "";
                    }
                });
            }
    
            dateSplit = false;
    
            // DATE TIMESTAMP
            const today = new Date();
            var date = formatDate(today, 't');
            document.getElementById("chat").innerHTML += dateString.replace("&MESSAGE", date);
            
            setTimeout(() => {  
                if (scroll) {
                    chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                }
            }, 100);
        }
    
        function formatDate(date, format) {
            const map = {
                mm: date.getMonth() + 1,
                dd: date.getDate(),
                yy: date.getFullYear().toString().slice(-2),
                yyyy: date.getFullYear(),
                t: date.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            }
    
            return format.replace(/mm|dd|yy|yyyy|t/gi, matched => map[matched])
        }
    
        function contextList(event) {
            event.preventDefault();
    
            var pageX = event.pageX;
            var pageY = event.pageY;
            const contextListE = document.getElementById("contextList");
    
            contextListE.style.display = "";
        
            pageX = clamp(pageX, 0, window.innerWidth - contextListE.offsetWidth);
            pageY = clamp(pageY, 0, window.innerHeight - contextListE.offsetHeight);
    
            contextListE.style.transform = "translate(" + pageX + "px, " + pageY + "px)";
        }
    
        var hidden = false;
    
        (function() {
            hidden = false;
    
            // Standards:
            if (hidden in document)
                document.addEventListener("visibilitychange", onchange);
            else if ((hidden = "mozHidden") in document)
                document.addEventListener("mozvisibilitychange", onchange);
            else if ((hidden = "webkitHidden") in document)
                document.addEventListener("webkitvisibilitychange", onchange);
            else if ((hidden = "msHidden") in document)
                document.addEventListener("msvisibilitychange", onchange);
            // IE 9 and lower:
            else if ("onfocusin" in document)
                document.onfocusin = document.onfocusout = onchange;
            // All others:
            else
                window.onpageshow = window.onpagehide
                = window.onfocus = window.onblur = onchange;
    
            function onchange (evt) {
                var v = "visible", h = "hidden",
                    evtMap = {
                    focus:v, focusin:v, pageshow:v, blur:h, focusout:h, pagehide:h
                    };
    
                evt = evt || window.event;
                if (evt.type in evtMap)
                document.body.className = evtMap[evt.type];
                else
                document.body.className = this[hidden] ? "hidden" : "visible";
            }
    
            // set the initial state (but only if browser supports the Page Visibility API)
            if( document[hidden] !== undefined )
                onchange({type: document[hidden] ? "blur" : "focus"});
            })();
    </script>    

    <div id="sound"></div>
</body>
