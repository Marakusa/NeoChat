<script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>

<body>
    <div id="disconnected" class="headerSideListBackground" style="display: none;transition: all 0.4s ease 0s;background-color: rgba(0, 0, 0, 0.7);z-index: 1000000;">
        <div class="disconnectedD">
            <h2 class="disconnectedH">Disconnected</h2>
            <hr>
            <p class="disconnectedT">Server closed.<br><br>Please refresh the page to try reconnecting...</p>
            <a onclick="location.reload();" class="disconnectedB">Reconnect</a>
            <a onclick="logout();" class="disconnectedB">Log Out</a>
        </div>
    </div>

    <div id="conencting" class="headerSideListBackground" style="
        user-select: none;
        transition: all 0.4s ease 0s;
        background-color: rgb(14 14 14);
        z-index: 1000000;
        right: 0;
        bottom: 0;
        top: 0;
        left: 0;
        position: fixed;
        filter: opacity(100%);
        transition: 0.5s;
    ">
        <div style="
            width: 300px;
            padding: 20px;
            margin: 0;
            background: rgb(29 29 29);
            display: flow-root;
            position: absolute;
            top: 50%;
            left: calc(50% - 170px);
            -ms-transform: translateX(50%) translateY(-50%);
            transform: translateX(calc(50% - 170px)) translateY(-50%);
        ">
            <img src="../img/loading.gif" width="100" style="margin: 0 auto;display: block;" draggable="false">
            <h2 style="margin: 0;text-align: center;">
                Connecting
            </h2>
            <p id="connectionProblems" style="text-align: center;display: none;">
                Connection problems? Let us know!
                <span style="margin-top: 16px;display: block;">Discord 
                    <span id="copyHelpDC" onclick="CopyToClipboard('copyHelpDC');" style="
                        cursor: pointer;
                        user-select: all;
                        background-color: rgb(0 0 0 / 45%);
                        padding: 5px;
                        border-radius: 10px;
                        margin-right: 10px;
                    "><span class="copyBubble" style="display: none;">Copied!</span>Mara#2222</span> 
                    <a href="https://github.com/Marakusa/NeoChat/issues" target="_blank" style="cursor: pointer;text-decoration-line: underline;">
                        GitHub
                    </a>
                </span>
            </p>
        </div>
    </div>
    
    <div class="header">
        &HEADERLEFTBUTTON
        <p class="headerTextLeft">&TITLEUSERNAME</p>
    </div>
    <div id="notifications"></div>
    <div id="sideMenu" class="headerSideList" style="margin-left: -100%;">
        <div class="userListContent" style="display: block;">
            <div name="chatUsersList" style="
                width: 230px;
                height: calc(100% - 10px);
                float: left;
                display: block;
                font-size: 24px;
                color: rgb(0 0 0);
                position: absolute;
                overflow-x: hidden;
                overflow-y: auto;
                padding: 5px;
                bottom: 0;
                right: 0;
                left: 0;
                top: 0;
                background-color: rgb(28 28 28);
                z-index: 5;
            ">

            </div>
        </div>
    </div>
    <div onclick="closeSideMenu();" id="headerSideListBackground" class="headerSideListBackground" style="transition: 0.4s;display: none;background-color: rgba(0, 0, 0, 0);"></div>
    
    <div class="mainContent">
        <div class="userListContent">
            <div name="chatUsersList">

            </div>
        </div>
        <div id="chatScroll" class="chatLogDevice chatLog">
            <div id="chat" class="chatLogHistory">
                
            </div>
        </div>
    </div>
    
    <div class="footer">
        <div id="emojiList" class="emojiList" style="display: none;">
            <h2>Emoji</h2>
            <div class="emojiListGrid">
                <div id="emojiListContent" class="emojiListContent">
                    
                </div>
            </div>
        </div>
        
        <div onclick="chatScroll.scrollTop = chatScroll.scrollHeight - chatScroll.clientHeight;" class="newMessage">
            <span>You have unread messages</span>
        </div>
        <a onclick="emojiOpen();" class="footerLeftButton">
            <div style="background-image: url(../../img/icon-emojis.svg);background-position: center;background-size: contain;width: 100%;height: 100%;"></div>
        </a>
        <textarea id="messageField" class="inputArea" placeholder="Message" maxlength="500" hidden></textarea>
        <span aria-label="Message" aria-multiline="true" data-can-focus="true" data-slate-editor="true" contenteditable="true" autocorrect="off" spellcheck="true" role="textbox" data-gramm="false" id="messageFieldSpan" class="inputArea" for="messageField" contenteditable></span>
        <a onclick="sendMessage();" class="footerSend buttonRound"><div style="background-image: url(../../img/send-arrow.svg);background-position: center;background-size: contain;width: 100%;height: 100%;"></div></a>
    </div>
    
    <div id="contextList" class="contextList" style="transform: translate(0px, 0px);display: none;">
        <p onclick="console.log('copy');">Copy</p>
        <p onclick="console.log('share');">Share</p>
        <hr>
        <p onclick="console.log('profile');">User Profile</p>
    </div>
    <div id="contextListP" class="contextList" style="transform: translate(0px, 0px);display: none;">
        <p onclick="goToProfile();">Profile</p>
        <hr>
        <p onclick="console.log('share');">Remove Friend</p>
        <p onclick="console.log('profile');">Block</p>
    </div>
    
    <script>
        $.mobile.showLoadMsg = false;
            
        $(document).on("mobileinit", function() {
            $.mobile.showLoadMsg = false;
        });


        var menuOpen = false;

        const sideMenu = document.getElementById("sideMenu");
        const headerSideListBackground = document.getElementById("headerSideListBackground");
    
        function openSideMenu() {

            if (menuOpen == false)
            {
                sideMenu.style.marginLeft = "0";
                headerSideListBackground.style.display = "block";
                setTimeout(() => {
                    headerSideListBackground.style.backgroundColor = "#000000b3";
                }, 10);
                menuOpen = true;
            }
            else
            {
                sideMenu.style.marginLeft = "-300px";
                headerSideListBackground.style.backgroundColor = "#00000000";
                menuOpen = false;
                setTimeout(() => {
                    headerSideListBackground.style.display = "none";
                }, 200);
            }
        }
        function closeSideMenu() {
            sideMenu.style.marginLeft = "-300px";
            headerSideListBackground.style.backgroundColor = "#00000000";
            menuOpen = false;
            setTimeout(() => {
                headerSideListBackground.style.display = "none";
            }, 200);
        }
    </script>

    <script>
        const sideMenu = document.getElementById("sideMenu");
        const headerSideListBackground = document.getElementById("headerSideListBackground");
    
        setTimeout(function () {
            document.getElementById("connectionProblems").style.display = "block";
        }, 10000);
        
        function CopyToClipboard(containerid) {
            if (document.selection) {
                var range = document.body.createTextRange();
                range.moveToElementText(document.getElementById(containerid));
                range.select().createTextRange();
                document.execCommand("copy");

                document.getElementById(containerid).childNodes[0].style.display = "inline";

                if (window.getSelection) {window.getSelection().removeAllRanges();}
                else if (document.selection) {document.selection.empty();}
                
                setTimeout(function () {
                    document.getElementById(containerid).childNodes[0].style.display = "none";
                }, 3000);
            } else if (window.getSelection) {
                var range = document.createRange();
                range.selectNode(document.getElementById(containerid));
                window.getSelection().addRange(range);
                document.execCommand("copy");

                document.getElementById(containerid).childNodes[0].style.display = "inline";

                if (window.getSelection) {window.getSelection().removeAllRanges();}
                else if (document.selection) {document.selection.empty();}
                
                setTimeout(function () {
                    document.getElementById(containerid).childNodes[0].style.display = "none";
                }, 3000);
            }
        }

        var emojis = new Array();

        // ALL EMOJIS
        // https://gist.githubusercontent.com/oliveratgithub/0bf11a9aff0d6da7b46f1490f86a71eb/raw/d8e4b78cfe66862cf3809443c1dba017f37b61db/emojis.json

        const clamp = (num, min, max) => Math.min(Math.max(num, min), max);
    
        document.body.addEventListener('click', function () { document.getElementById("contextList").style.display = "none"; document.getElementById("contextListP").style.display = "none"; }, true);
        document.body.addEventListener('scroll', function () { document.getElementById("contextList").style.display = "none"; document.getElementById("contextListP").style.display = "none"; }, true);

        function getMobileOperatingSystem() {
            var userAgent = navigator.userAgent || navigator.vendor || window.opera;
    
            // Windows Phone must come first because its UA also contains "Android"
            if (/windows phone/i.test(userAgent)) {
                return "winphone";
            }
    
            if (/android/i.test(userAgent)) {
                return "android";
            }
    
            // iOS detection from: http://stackoverflow.com/a/9039885/177710
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                return "ios";
            }
    
            return "";
        }
    
        function applyAfterResize() {
            if (getMobileOperatingSystem() != '') {
                chatScroll.scrollTop = chatScroll.scrollHeight + 10;
            }
        }
    
        $(window).on('resize orientationchange', function(){
            applyAfterResize();
        });
    
        function logout() {
            document.cookie = "token=; path=/";
            window.location.href = "../../signin";
        }
    
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    
        const userListButton = `<a href="@&USERNAMELINK" id="user&UID" class="users">
            <div class="listUser">
                <p id="listUserName&UID" class="listUserName">&USERNAME</p>
            </div>
        </a>`;
        const notification = `<div id="notification&ID" class="notification">
            <span style="user-select: none;float: right;color: grey;top: 0;margin: 5px;cursor: pointer;" onclick="document.getElementById('notification&ID').outerHTML = '';">Dismiss</span>
            <a class="notiflink" href="@&LINKUSERNAME">
                <h3>New message from &USERNAME</h3>
                <p>&MESSAGE</p>
            </a>
        </div>`;
        var chatplaceholder = `<div class="chat-loading">
            <div class="message" style="background: transparent;">
                <div class="chat-loading-avatar"></div>
                <div class="messageContent">
                    <p class="chat-loading-name" style="width: 100px;"></p>
                    <div class="chat-loading-text" style="width: 240px;"></div>
                    <div class="chat-loading-text" style="width: 190px;"></div>
                </div>
            </div>
        </div>`;
        
        const theyBubble = "<div id=\"bubble&ID\" class=\"bubble bubbleLeft\">&MESSAGE</div>";
        const meBubble = "<div id=\"bubble&ID\" class=\"bubble bubbleRight\">&MESSAGE</div>";
    
        var xhr = null;
        var interval = null;
    
        var myusername = "";
        var chatusername = "";
        var chatuserid = "";
        var token = getCookie("token");
    
        // Socket.io init
        var socket = io();
        socket.emit('settoken', token);
        socket.emit('getpage', document.documentURI.replace(/^[^#]*?:\/\/.*?\//, "/"), token);
        socket.on('message', receiveMessage);
        socket.on('addhistory', addHistory);
        socket.on('page', pageLoad);
        socket.on('userlist', getUserList);
        socket.on('setusername', setUsername);
    
        socket.on('userstatus', receiveUserStatus);
        
        socket.on('redirect', function(destination) {
            window.location.href = destination;
        });

        function count(obj) {
            var count=0;
            for(var prop in obj) {
                if (obj.hasOwnProperty(prop)) {
                    ++count;
                }
            }
            return count;
        }
        
        var mepage = false;
        var ppage = false;
        var gpage = false;
        var sepage = false;

        // AFK timer
        function timerIncrement() {
            idleTime = idleTime + 1;
            if (idleTime > 9) { // afk for over 10 minutes
                socket.emit('setuserstatus', 2, token);
            }
        }
        
        // AFK timer restetter
        var idleTime = 0;
        $(document).ready(function () {
            // Increment the idle time counter every minute.
            var idleInterval = setInterval(timerIncrement, 60000); // 1 minute
            
            $(this).mousemove(function (e) {
                idleTime = 0;
                if (socket !== null && socket.connected) {
                    socket.emit('setuserstatus', 1, token);
                }
            });
            $(this).click(function (e) {
                idleTime = 0;
                if (socket !== null && socket.connected) {
                    socket.emit('setuserstatus', 1, token);
                }
            });
            $(this).keypress(function (e) {
                idleTime = 0;
                if (socket !== null && socket.connected) {
                    socket.emit('setuserstatus', 1, token);
                }
            });
        });
    
        // User status received
        function receiveUserStatus(data) {
            if (document.getElementById('listUserName' + data.user)) {
                var user = document.getElementById('listUserName' + data.user);
                user.childNodes[0].classList.remove("userStatus1");
                user.childNodes[0].classList.remove("userStatus2");
                user.childNodes[0].classList.remove("userStatus3");
                
                if (user.childNodes[0].classList.contains("userStatus0") == true || data.status == "0") {
                    user.childNodes[0].classList.add("userStatus" + data.status);
                }
                //user.innerHTML = "<span class=\"userStatus" + data.status + "\"></span>" + user.innerHTML.split("</span>")[1];
            }
        }
    
        document.getElementById("emojiList").style.display = "none";
    
        var chatHeightEmoji = "calc(100% - 64px - 60px - 10px - 250px)";
        var footerBottomEmoji = "250px";
    
        var emojicontent = document.getElementById("emojiListContent");
        var emoji = `<div onclick="emoji('_');" id="_" class="emoji">EMOJIICON</div>`;
    
        const messageFieldSpan = document.getElementById("messageFieldSpan");
        const messageField = document.getElementById("messageField");

        // Add emoji from menu when clicked
        function emojiclick(emojitag) {
            messageFieldSpan.innerText += document.getElementById(emojitag).id;
            messageFieldSpan.focus();
        }
    
        // Emoji panel opened -> load emojis
        function emojiOpen() {
            const emojis = document.getElementById("emojiList");
            
            if (emojis.style.display == "none") {
                emojis.style.display = "";
            }
            else {
                emojis.style.display = "none";
            }
    
            // Load emojis
            if (emojicontent.innerHTML.trim() == "") {
                $.ajax({
                    url: "/data/emojis.txt",
                    success: function (data){
                        emojicontent.innerHTML = data;
                    }
                });
            }
        }
        
        var dateString = "<p id=\"timestamp\" name=\"timestamp\" class=\"bubbleSent\" style=\"display: block;\">&MESSAGE</p>";
        var dateSplit = true;
    
        // Send message by pressing enter key
        $(function() {
            $("#messageFieldSpan").keypress(function (e) {
                if(e.which == 13 && e.shiftKey == false) {
                    sendMessage();
                    e.preventDefault();
                }
            });
        });

        var chatScroll = null;
        var newMessage = null;

        var lastMessage = "";

        const headerBackButton = "<a href=\"@me\" id=\"headerBack\" class=\"headerBack buttonRound\"><div style=\"background-image: url(../img/back-arrow.svg);background-position: center;background-size: contain;width: 100%;height: 100%;\"></div></a>";
        const headerMenuButton = "<a onclick=\"openSideMenu();\" class=\"headerBack buttonRound\"><div style=\"background-image: url(../img/menu-lines.svg);background-position: center;background-size: contain;width: 100%;height: 100%;\"></div></a>";
        const headerText = "<p class=\"headerTextLeft\">&TITLE</p>";

        const loadMore = "<div id=\"loadinghistory\" style=\"width: 100%;height: 100px;display: inline-block;\"><img src=\"../img/loading.gif\" height=\"100\" style=\"margin: 0 auto;display: block;\"></div>";

        var lastchatusername = "";

        setInterval(function () {
            
            if (document.documentURI && lastchatusername &&
                document.getElementsByName("user" + lastchatusername.toLowerCase()) &&
                document.getElementsByName("user" + (document.documentURI).split("@")[1].toLowerCase())) {

                var last = document.getElementsByName("user" + lastchatusername.toLowerCase());
                var recent = document.getElementsByName("user" + (document.documentURI).split("@")[1].toLowerCase());

                if (last.length > 0) {
                    if (last[0].classList.contains("selectedUser") == true) {
                        last[0].classList.remove("selectedUser");
                    }
                    if (last[1].classList.contains("selectedUser") == true) {
                        last[1].classList.remove("selectedUser");
                    }
                }
                if (recent.length > 0) {
                    if (recent[0].classList.contains("selectedUser") == false) {
                        recent[0].classList.add("selectedUser");
                    }
                    if (recent[1].classList.contains("selectedUser") == false) {
                        recent[1].classList.add("selectedUser");
                    }
                }

                lastchatusername = (document.documentURI).split("@")[1].toLowerCase();
            }
            
        }, 100);

        function setUsername(username) {
            myusername = username;
        }

        $(document).ready(function() {
            $(document).on("swiperight", ".mainContent", function(e) {
                if (e.type === "swiperight") {
                    if (window.innerWidth < 540) {
                        openSideMenu();
                    }
                }
            });
            $(document).on("swipeleft", ".sideMenu", function(e) {
                if (e.type === "swipeleft") {
                    closeSideMenu();
                }
            });
        });
        
        var loadedhistory = [];

        var historyPending = false;

        var historyTopInterval;

        // Load page
        function pageLoad(code, data, chatUserId, chatUser, lastmsg) {
            historyTopInterval = null;

            loadedhistory = [];
            historyPending = false;

            if (lastmsg !== undefined) {
                lastMessage = lastmsg;
            }

            chatusername = (document.documentURI).split("@")[1];
            chatuserid = chatUserId;

            document.getElementById("chat").innerHTML = (chatusername == "se" ? "" : loadMore) + data;

            chatScroll = document.getElementById("chatScroll");
            chatScroll.scrollTop = chatScroll.scrollHeight - chatScroll.clientHeight;

            mepage = (document.documentURI).endsWith("@me", document.documentURI.length);
            ppage = (document.documentURI).endsWith("@p", document.documentURI.length);
            gpage = (document.documentURI).endsWith("@g", document.documentURI.length);
            sepage = (document.documentURI).endsWith("@se", document.documentURI.length);

            var header = document.getElementsByClassName("header")[0];
        
            if (mepage == true) {
                document.getElementsByClassName("footer")[0].style.display = "none";
                //document.getElementById("welcomeText").style.display = "block";
                header.innerHTML = headerMenuButton + headerText.replace(/&TITLE/g, "NeoChat");
                //if (document.getElementById("messageHistoryTitle")) {
                //    document.getElementById("messageHistoryTitle").innerText = "Here is your friends list.";
                //}
            }
            else if (ppage == true) {
                document.getElementsByClassName("footer")[0].style.display = "";
                header.innerHTML = headerMenuButton + headerText.replace(/&TITLE/g, "Profile");
            }
            else if (gpage == true) {
                document.getElementsByClassName("footer")[0].style.display = "";
                header.innerHTML = headerMenuButton + headerText.replace(/&TITLE/g, "#general");
            }
            else if (sepage == true) {
                document.getElementsByClassName("footer")[0].style.display = "none";
                header.innerHTML = headerMenuButton + headerText.replace(/&TITLE/g, "User Settings");
            }
            else {
                document.getElementsByClassName("footer")[0].style.display = "";
                //document.getElementById("welcomeText").style.display = "none";
                header.innerHTML = headerMenuButton + headerText.replace(/&TITLE/g, chatUser);

                var allBubbles = document.getElementsByClassName('message');
                for (var i=0, len=allBubbles.length|0; i<len; i=i+1|0) {
                    var id = allBubbles[i].id.substring(("message").length);
                    allBubbles[i].addEventListener('contextmenu', function (ev) { contextList(ev, id); }, false);
                }
            }
            
            newMessage = document.getElementsByClassName("newMessage")[0];
            newMessage.style.display = "none";
        
            if (mepage == false) {
                setTimeout(() => {
                    chatScroll.scrollTop = chatScroll.scrollHeight - chatScroll.clientHeight;
                }, 10);
        
                setInterval(() => {
                    if (Math.round(chatScroll.scrollTop) >= Math.round(chatScroll.scrollHeight - chatScroll.clientHeight)) {
                        newMessage.style.display = "none";
                        document.title = "NeoChat";
                    }
                }, 100);
            }
            
            document.getElementById("conencting").style.filter = "opacity(0%)";
            setTimeout(() => {
                document.getElementById("conencting").style.display = "none";
            }, 500);
            
            var allBubbles = document.getElementsByClassName('message');
            for (var i=0, len=allBubbles.length|0; i<len; i=i+1|0) {
                var id = allBubbles[i].id.substring(("message").length);
                allBubbles[i].addEventListener('contextmenu', function (ev) { contextList(ev, id); }, false);
            }
            
            setInterval(function () {
                if (socket !== null && socket.connected == false) {
                    document.getElementById("disconnected").style.display = "";
                    socket = null;
                }
            }, 1000);
            
            historyTopInterval = setInterval(() => {
                if (document.getElementById("chatScroll").scrollTop < 100 && !historyPending) {
                    historyPending = true;
                    
                    if (socket !== null && socket.connected) {
                        socket.emit("loadmoremsg", chatuserid, token, lastMessage);
                    }
                }
            }, 100);

            socket.emit('getuserlist', token);
        }
        function goToProfile() {
            goTo("@" + selectedUsername);
        }
        function goTo(url) {
            showLoadingChat();
            socket.emit('getpage', url.replace(/^[^#]*?:\/\/.*?\//, "/"), token);
            window.history.pushState({"html": document.outerHTML, "pageTitle": document.title},"", url);
        }
        function getUserList(code, data) {
            document.getElementsByName("chatUsersList")[0].innerHTML = data;
            document.getElementsByName("chatUsersList")[1].innerHTML = data;
            
            for (var i = 0; i < document.getElementsByClassName("users").length; i++) {
                var e = document.getElementsByClassName("users")[i];
                e.addEventListener('contextmenu', function (ev) { contextListP(ev, e.href.split("@")[1]); }, false);
            }
            
            $(document).ready(function() {
                $('.users').off();
                $('#headerBack').off();
                $('.users').click(function() {
                    sideMenu.style.marginLeft = "-300px";
                    headerSideListBackground.style.backgroundColor = "#00000000";
                    menuOpen = false;
                    setTimeout(() => {
                        headerSideListBackground.style.display = "none";
                    }, 200);

                    showLoadingChat();
                    socket.emit('getpage', $(this)[0].href.replace(/^[^#]*?:\/\/.*?\//, "/"), token);
                    window.history.pushState({"html": document.outerHTML, "pageTitle": document.title},"", $(this)[0].href);

                    clickAssigned = true;

                    return false;
                });
                $('#headerBack').click(function() {
                    showLoadingChat();
                    socket.emit('getpage', $(this)[0].href.replace(/^[^#]*?:\/\/.*?\//, "/"), token);
                    window.history.pushState({"html": document.outerHTML, "pageTitle": document.title},"", $(this)[0].href);

                    clickAssigned = true;

                    return false;
                });
            });
        }
        function addHistory(data, lastId) {
            historyPending = false;
            var oldheight = chatScroll.scrollHeight - chatScroll.clientHeight;
            
            if (!loadedhistory.includes(data)) {
                loadedhistory.push(data);

                lastMessage = lastId;

                if (document.getElementById("messagehistory")) {
                    document.getElementById("messagehistory").innerHTML = data + document.getElementById("messagehistory").innerHTML;
                }
            }

            var newheight = chatScroll.scrollHeight - chatScroll.clientHeight;

            chatScroll.scrollTop = chatScroll.scrollTop + newheight - oldheight;
        }
        socket.on("nomorehistory", function () {
            historyPending = false;
            if (document.getElementById("loadinghistory")) {
                document.getElementById("loadinghistory").style.display = "none";
            }
        });
        function receiveMessage(data) {
            var chatScroll = document.getElementById("chatScroll");
            var scroll = false;
            
            if (Math.round(chatScroll.scrollTop) >= Math.round(chatScroll.scrollHeight - chatScroll.clientHeight)) {
                scroll = true;
            }
            
            console.log(data);

            // Check if user sent message from is not same as client
            if (data.from.toLowerCase() !== myusername.toLowerCase() || (data.general !== undefined && data.general == true)) {
                // Is on the same private chat page
                if (data.from.toLowerCase() == chatusername.toLowerCase()) {
                    var sendStatus = document.getElementById("sendStatus");
                    sendStatus.innerText = "Seen";
        
                    message = "";
        
                    var htmlCode = data.element.replace(/&lt;br&gt;/g, "<br>");

                    var parser = new DOMParser();
	                var doc = parser.parseFromString(htmlCode, 'text/html').childNodes[0].childNodes[1].childNodes[0];
                    var id = doc.id.substring(("message").length);
        
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(htmlCode, 'text/html').childNodes[0].childNodes[1].childNodes[0];
                    var id = doc.id.substring(("message").length);

                    document.getElementById("chat").innerHTML += htmlCode;
        
                    document.getElementById("message" + id).addEventListener('contextmenu', function (ev) { contextList(ev, id); }, false);
                    
                    dateSplit = true;

                    setTimeout(() => {  
                        if (scroll && document[hidden] == false) {
                            chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                            document.title = "NeoChat";
                        }
                        else {
                            playPing();
                            newMessage.style.display = "";
                        }
                    }, 100);
        
                    /*if (mepage == false && ppage == false && gpage == false) {
                        setTimeout(() => {  
                            if (scroll && document[hidden] == false) {
                                chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                                document.title = "NeoChat";
                            }
                            else {
                                playPing();
                                newMessage.style.display = "";
                            }
                        }, 100);
                    }
                    else {
                        playPing();
                    }*/
                }
                // Message is sent in general and client is on general page
                else if (chatusername.toLowerCase() == "g" && data.general !== undefined && data.general == true) {
                    var htmlCode = data.element.replace(/&lt;br&gt;/g, "<br>");
                    
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(htmlCode, 'text/html').childNodes[0].childNodes[1].childNodes[0];
                    var id = doc.id.substring(("message").length);

                    document.getElementById("chat").innerHTML += htmlCode;
                
                    document.getElementById("message" + id).addEventListener('contextmenu', function (ev) { contextList(ev, id); }, false);

                    setTimeout(() => {  
                        if (scroll && document[hidden] == false) {
                            chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                            document.title = "NeoChat";
                        }
                        else {
                            playPing();
                            newMessage.style.display = "";
                        }
                    }, 100);
                }
                // Message is sent in general and client is on a different page
                else if (chatusername.toLowerCase() !== "g" && data.general !== undefined && data.general == true) {
                    playPing();
        
                    var msg = data.message;
        
                    if (data.message.length > 50) {
                        msg = data.message.substring(0, 50) + "...";
                    }
        
                    id = Math.floor((Math.random() * 999999) + 1);
        
                    var htmlCode = notification
                                    .replace(/&ID/g, id)
                                    .replace(/&LINKUSERNAME/g, "g")
                                    .replace(/&USERNAME/g, data.from + " in #general")
                                    .replace(/&MESSAGE/g, msg);
                                    
                    var notifications = document.getElementById("notifications");
        
                    const placeholder = document.createElement('div');
                    placeholder.innerHTML = htmlCode;
                    const node = placeholder.firstElementChild;
        
                    notifications.insertBefore(node, notifications.firstChild);
        
                    if (mepage == false && ppage == false && gpage == false) {
                        setTimeout(() => {  
                            if (scroll) {
                                chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                                document.title = "NeoChat";
                            }
                            else {
                                newMessage.style.display = "";
                            }
                        }, 100);
                    }
        
                    notificated("notification" + id);

                    return;
                }
                // Client is on a different page
                else {
                    playPing();
        
                    var msg = data.message;
        
                    if (data.message.length > 50) {
                        msg = data.message.substring(0, 50) + "...";
                    }
        
                    id = Math.floor((Math.random() * 999999) + 1);
        
                    var htmlCode = notification
                                    .replace(/&ID/g, id)
                                    .replace(/&USERNAME/g, data.from)
                                    .replace(/&LINKUSERNAME/g, data.from)
                                    .replace(/&MESSAGE/g, msg);
                                    
                    var notifications = document.getElementById("notifications");
        
                    const placeholder = document.createElement('div');
                    placeholder.innerHTML = htmlCode;
                    const node = placeholder.firstElementChild;
        
                    notifications.insertBefore(node, notifications.firstChild);
        
                    if (mepage == false && ppage == false && gpage == false) {
                        setTimeout(() => {  
                            if (scroll) {
                                chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                                document.title = "NeoChat";
                            }
                            else {
                                newMessage.style.display = "";
                            }
                        }, 100);
                    }
        
                    notificated("notification" + id);

                    return;
                }
            }
            // Local message sent
            else if (data.to !== undefined && data.to.toLowerCase() == chatusername.toLowerCase() && data.from.toLowerCase() == myusername.toLowerCase()) {
                var htmlCode = data.element.replace(/&lt;br&gt;/g, "<br>");
                
                var parser = new DOMParser();
                var doc = parser.parseFromString(htmlCode, 'text/html').childNodes[0].childNodes[1].childNodes[0];
                var id = doc.id.substring(("message").length);

                document.getElementById("chat").innerHTML += htmlCode;
            
                document.getElementById("message" + id).addEventListener('contextmenu', function (ev) { contextList(ev, id); }, false);
            }
            
            setTimeout(() => {  
                if (scroll) {
                    chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                }
            }, 100);
        }
    
        function playPing() {
            setTimeout(function () {
                var mp3Source = '<source src="/sounds/ping.mp3" type="audio/mpeg">';
                var embedSource = '<embed hidden="true" autostart="true" loop="false" src="/sounds/ping.mp3">';
                document.getElementById("sound").innerHTML = '<audio autoplay="autoplay">' + mp3Source + embedSource + '</audio>';
    
                var audio = document.getElementById("sound").childNodes[0];
    
                if (getMobileOperatingSystem() == '') {
                    audio.volume = 0.2;
                }
    
                document.title = "(1) NeoChat";
            }, 100);
    
            /*var sound = new Audio({
                src: ['/sounds/ping.wav'],
                autoplay: true,
                loop: false,
                muted: true
            });
            sound.play();*/
        }
    
        function notificated(id) {
            
            $(document).ready(function() {
                $('.notiflink').off();
                $('.notiflink').click(function() {
                    showLoadingChat();
                    socket.emit('getpage', $(this)[0].href.replace(/^[^#]*?:\/\/.*?\//, "/"), token);
                    window.history.pushState({"html": document.outerHTML, "pageTitle": document.title},"", $(this)[0].href);

                    document.getElementById(id).style.transform = "translateX(-350px) translateY(0px)";
                
                    setTimeout(() => {  
                        document.getElementById(id).outerHTML = "";
                    }, 200);
                    
                    return false;
                });
            });

            document.getElementById(id).style.transition = "0.2s";
            document.getElementById(id).style.transform = "translateX(0px) translateY(-200px)";
    
            setTimeout(() => {  
                document.getElementById(id).style.transform = "translateX(0px) translateY(0px)";
            }, 10);
    
            setTimeout(() => {  
                
                document.getElementById(id).style.transform = "translateX(-350px) translateY(0px)";
                
                setTimeout(() => {  
                    document.getElementById(id).outerHTML = "";
                }, 200);
    
            }, 10000);
        }

        function showLoadingChat() {
            document.getElementById("chat").innerHTML = chatplaceholder;

            var m = document.getElementById("chat").childNodes[0].innerHTML;
            var c = document.getElementById("chat").childNodes[0];
            
            for (var i = 0; i < 10; i++) {
                c.innerHTML += m;
            }
        }
        
        function getHTML(who, deep){
            if(!who || !who.tagName) return '';
            var txt, ax, el= document.createElement("div");
            el.appendChild(who.cloneNode(false));
            txt= el.innerHTML;
            if(deep){
                ax= txt.indexOf('>')+1;
                txt= txt.substring(0, ax)+who.innerHTML+ txt.substring(ax);
            }
            el= null;
            return txt;
        }

        function sendMessage()
        {
            messageField.value = messageFieldSpan.innerHTML;
            messageFieldSpan.focus();
    
            var sendStatus = document.getElementById("sendStatus");
            sendStatus.innerText = "Seen";
    
            message = "";
    
            var chatScroll = document.getElementById("chatScroll");
            var scroll = false;
            if (Math.round(chatScroll.scrollTop) >= Math.round(chatScroll.scrollHeight - chatScroll.clientHeight)) {
                scroll = true;
            }
    
            document.getElementById("emojiList").style.display = "none";
            
            var msg = messageField.value;
    
            messageField.value = "";
    
            if (msg.length <= 500 && msg.trim() !== "") {
                socket.emit('message', chatusername, token, msg);
                
                /*var emojiarray = new Array(msg.match(/:[^:\s]*(?:::[^:\s])*:/g));
                if (emojiarray[0] != null) {
                    for (var i = 0; i < emojiarray[0].length; i++) {
                        msg = msg.replace(emojiarray[0][i], findEmoji(emojiarray[0][i]));
                    }
                }*/
                
                id = Math.floor((Math.random() * 999999) + 1);
                //var htmlCode = meBubble.replace("&MESSAGE", msg).replace("&ID", id);
                //document.getElementById("chat").innerHTML += htmlCode;
            }

            messageField.value = "";
            messageFieldSpan.innerHTML = "";
        }
    
        function messageSentConfirm(message) {
            document.getElementById("sendStatus").style.display = "none";
    
            var chatScroll = document.getElementById("chatScroll");
            var scroll = false;
            if (Math.round(chatScroll.scrollTop) >= Math.round(chatScroll.scrollHeight - chatScroll.clientHeight)) {
                scroll = true;
            }
    
            id = Math.floor((Math.random() * 999999) + 1);
            document.getElementById("chat").innerHTML += "<div id=\"chatBubble" + id + "\" class=\"bubble bubbleRight\">" + message + "</div>";
            
            var sendStatus = document.getElementById("sendStatus");
            sendStatus.style.display = "block";
            sendStatus.parentNode.appendChild(sendStatus);
    
            if (dateSplit == false)
            {
                document.getElementsByName("timestamp").forEach(element => {
                    if (element.id != "")
                    {
                        element.style.display = "none";
                        element.id = "";
                    }
                });
            }
            else
            {
                document.getElementsByName("timestamp").forEach(element => {
                    if (element.id != "")
                    {
                        element.id = "";
                    }
                });
            }
    
            dateSplit = false;
    
            // DATE TIMESTAMP
            const today = new Date();
            var date = formatDate(today, 't');
            document.getElementById("chat").innerHTML += dateString.replace("&MESSAGE", date);
            
            setTimeout(() => {  
                if (scroll) {
                    chatScroll.scrollTop = chatScroll.scrollHeight + 10;
                }
            }, 100);
        }
    
        function formatDate(date, format) {
            const map = {
                mm: date.getMonth() + 1,
                dd: date.getDate(),
                yy: date.getFullYear().toString().slice(-2),
                yyyy: date.getFullYear(),
                t: date.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            }
    
            return format.replace(/mm|dd|yy|yyyy|t/gi, matched => map[matched])
        }
    
        var selectedMessageId = "";

        function contextList(event, messageid) {
            selectedMessageId = messageid;

            event.preventDefault();

            var pageX = event.pageX;
            var pageY = event.pageY;
            const contextListE = document.getElementById("contextList");

            contextListE.style.display = "";
        
            pageX = clamp(pageX, 0, window.innerWidth - contextListE.offsetWidth);
            pageY = clamp(pageY, 0, window.innerHeight - contextListE.offsetHeight);

            contextListE.style.transform = "translate(" + pageX + "px, " + pageY + "px)";
        }
    
        function contextListP(event, username) {
            selectedUsername = username;

            event.preventDefault();
    
            var pageX = event.pageX;
            var pageY = event.pageY;
            const contextListE = document.getElementById("contextListP");
    
            contextListE.style.display = "";
        
            pageX = clamp(pageX, 0, window.innerWidth - contextListE.offsetWidth);
            pageY = clamp(pageY, 0, window.innerHeight - contextListE.offsetHeight);
    
            contextListE.style.transform = "translate(" + pageX + "px, " + pageY + "px)";
        }
    
        var hidden = false;
    
        (function() {
            hidden = false;
    
            // Standards:
            if (hidden in document)
                document.addEventListener("visibilitychange", onchange);
            else if ((hidden = "mozHidden") in document)
                document.addEventListener("mozvisibilitychange", onchange);
            else if ((hidden = "webkitHidden") in document)
                document.addEventListener("webkitvisibilitychange", onchange);
            else if ((hidden = "msHidden") in document)
                document.addEventListener("msvisibilitychange", onchange);
            // IE 9 and lower:
            else if ("onfocusin" in document)
                document.onfocusin = document.onfocusout = onchange;
            // All others:
            else
                window.onpageshow = window.onpagehide
                = window.onfocus = window.onblur = onchange;
    
            function onchange (evt) {
                var v = "visible", h = "hidden",
                    evtMap = {
                    focus:v, focusin:v, pageshow:v, blur:h, focusout:h, pagehide:h
                    };
    
                evt = evt || window.event;
                if (evt.type in evtMap)
                document.body.className = evtMap[evt.type];
                else
                document.body.className = this[hidden] ? "hidden" : "visible";
            }
    
            // set the initial state (but only if browser supports the Page Visibility API)
            if( document[hidden] !== undefined )
                onchange({type: document[hidden] ? "blur" : "focus"});
        })();
        
    </script>
    
    <script>
        var qrLoaded = false;

        function getQr() {
            if (!qrLoaded) {
                socket.emit('requestqr', token);
            }
            else {
                document.getElementById("qrimage").src = "";
                document.getElementById("qrgenb").innerText = "Generate QR Code";
                qrLoaded = false;
            }
        }
        socket.on('returnqr', (username) => {
            window.qrcode = new QrCodeWithLogo({
                content: "signin?t=" + token + "&n=" + username,
                width: 380,
                image: document.getElementById("qrimage"),
                logo: {
                src: "../img/app-icon.svg",
                logoSize: 0.224
                }
            }).toImage().then(function () {
                document.getElementById("qrgenb").innerText = "Hide QR Code";
                qrLoaded = true;
            });
        });
    </script>

    <div></div>

    <script>
        var side = "left";

        setInterval(function () {

            var e = document.getElementsByClassName("chat-loading-text");
            var n = document.getElementsByClassName("chat-loading-name");

            if (side == "left") {
                side = "right";
            }
            else {
                side = "left";
            }

            for (var i = 0; i < e.length; i++) {
                e[i].style.backgroundPosition = side;
            }

            for (var i = 0; i < n.length; i++) {
                n[i].style.backgroundPosition = side;
            }
            
        }, 1000);
    </script>

    <div id="sound"></div>
</body>
