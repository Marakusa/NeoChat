<!DOCTYPE html>
<html>
    <head>
        <title>NeoChat</title>
        <link rel="shortcut icon" href="img/AppIcon.svg">
        <link rel="stylesheet" href="css/style.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <div class="loginBackground" style="background-image: url(img/MainBackground.svg);"></div>
        <div class="loginContent">
            <div class="logo" style="background-image: url(img/AppIcon.svg);">
                <span class="logoText">NeoChat</span>
            </div>
            <form id="loginform" style="position: absolute;width: 100%;transition: 0.5s;">
                <input type="text" maxlength="20" id="usernameField" name="usernameField" class="inputArea inputForm" placeholder="Username" style="margin-top: 30px;" />
                <input type="password" maxlength="50" id="passwordField" name="passwordField" class="inputArea inputForm" placeholder="Password" style="margin-top: 5px;" />
                <p id="logErr" class="loginError" style="display: none;"><span onclick="closeError('logErr');" class="errorClose">&#10006;</span><span>ERROR</span></p>
                <input type="submit" name="submitLogIn" class="inputArea inputForm" value="Log In" style="margin-top: 15px;height: 40px;width: calc(70% + 34px);" />
                <a onclick="showpanel(3);" class="loginOption">Forgot your password?</a>
                <a onclick="showpanel(2);" class="loginOption">Don't have an account?</a>
            </form>
            <form id="registerform" style="position: absolute;width: 100%;transition: 0.5s;display: none;filter: opacity(0);">
                <input type="text" maxlength="20" id="usernameFieldR" name="usernameFieldR" class="inputArea inputForm" placeholder="Username" style="margin-top: 30px;">
                <input type="email" maxlength="200" id="emailFieldR" name="emailFieldR" class="inputArea inputForm" placeholder="Email" style="margin-top: 5px;">
                <input type="password" maxlength="50" id="passwordFieldR" name="passwordFieldR" class="inputArea inputForm" placeholder="Password" style="margin-top: 5px;">
                <input type="password" maxlength="50" id="passwordField2R" name="passwordFieldR" class="inputArea inputForm" placeholder="Retype Password" style="margin-top: 5px;">
                <p id="regErr" class="loginError" style="display: none;"><span onclick="closeError('regErr');" class="errorClose">&#10006;</span><span>ERROR</span></p>
                <input type="submit" name="submitRegister" class="inputArea inputForm" value="Register" style="margin-top: 15px;height: 40px;width: calc(70% + 34px);">
                <a onclick="showpanel(0);" class="loginOption">Already have an account?</a>
            </form>
            <div id="loggingin" style="position: absolute;width: 100%;transition: 0.5s;filter: opacity(0);display: none;text-align: center;">
                <p style="margin: 0 auto;margin-top: 30px;width: calc(70% + 34px);font-size: 22px;border: solid;border-width: 1px;border-color: #ffe264;padding: 30px 0;border-radius: 10px;">
                    Logging in...
                </p>
            </div>
        </div>
    </body>

    <script>
        var panel = 0;

        var loginPanel = document.getElementById("loginform");
        var registerPanel = document.getElementById("registerform");
        var logginginPanel = document.getElementById("loggingin");
        
        var loginError = document.getElementById("logErr");
        var registerError = document.getElementById("regErr");

        var submitting = false;
        var done = false;
        var error = false;
        var timeout = false;
        var fadeReady = true;

        function closeError(id) {
            document.getElementById(id).style.display = "none";
        }

        // 1: Login, 2: Logging in, 3: Register, 4: Password reset
        function showpanel(panelname) {
            if (fadeReady == true) {
                if (panelname <= 3) fadeReady = false;

                if (panelname == 0) {
                    panel = panelname;

                    if (logginginPanel.style.display !== "none") {
                        logginginPanel.style.filter = "opacity(0)";
                        setTimeout(function () {
                            logginginPanel.style.display = "none";
                        }, 500);
                    }
                    if (registerPanel.style.display !== "none") {
                        registerPanel.style.filter = "opacity(0)";
                        setTimeout(function () {
                            registerPanel.style.display = "none";
                        }, 500);
                    }

                    loginPanel.style.display = "block";
                    loginPanel.style.filter = "opacity(1)";
                }
                else if (panelname == 1) {
                    panel = panelname;

                    if (loginPanel.style.display !== "none") {
                        loginPanel.style.filter = "opacity(0)";
                        setTimeout(function () {
                            loginPanel.style.display = "none";
                        }, 500);
                    }
                    if (registerPanel.style.display !== "none") {
                        registerPanel.style.filter = "opacity(0)";
                        setTimeout(function () {
                            registerPanel.style.display = "none";
                        }, 500);
                    }

                    logginginPanel.style.display = "block";
                    logginginPanel.style.filter = "opacity(1)";
                }
                else if (panelname == 2) {
                    panel = panelname;

                    if (logginginPanel.style.display !== "none") {
                        logginginPanel.style.filter = "opacity(0)";
                        setTimeout(function () {
                            logginginPanel.style.display = "none";
                        }, 500);
                    }
                    if (loginPanel.style.display !== "none") {
                        loginPanel.style.filter = "opacity(0)";
                        setTimeout(function () {
                            loginPanel.style.display = "none";
                        }, 500);
                    }

                    registerPanel.style.display = "block";
                    registerPanel.style.filter = "opacity(1)";
                }
            
                if (panelname <= 3) {
                    setTimeout(function () {
                        fadeReady = true;
                    }, 600);
                }
            }
        }

        $(document).ready(function () {
            $("form").submit(function (event) {
                if (submitting == false && panel == 0) {
                    timeout = false;
                    done = false;
                    error = false;
                    submitting = true;

                    var l_username = document.getElementById("usernameField").value;
                    var l_password = document.getElementById("passwordField").value;

                    showpanel(1);

                    $.ajax({
                        dataType: "json",
                        type: "POST",
                        url: "login",
                        data: {username: l_username, password: l_password},
                        timeout: 10000,
                        error: function (error, response, data) {
                            showpanel(0);

                            console.error(error);
                            console.error(response);
                            console.error(data);
                            done = true;
                            error = true;
                            submitting = false;

                            loginError.style.display = "block";
                            loginError.lastChild.innerText = response.substring(0, 1).toUpperCase() + response.substring(1, response.length);
                        },
                        success: function (data) {
                            done = true;
                            error = false;
                            submitting = false;
                            
                            console.log(data["registerstatus"] + ": " + data["message"]);
                            if (data["registerstatus"] === "0") {
                                setTimeout(function () {
                                    window.location.href = "index.html";
                                }, 1000);
                            }
                            else {
                                setTimeout(function () {
                                    showpanel(0);
                                    
                                    loginError.style.display = "block";
                                    loginError.lastChild.innerText = data["message"];
                                }, 1000);
                            }
                        }
                    });
                }
                else if (submitting == false && panel == 2) {
                    timeout = false;
                    done = false;
                    error = false;
                    submitting = true;

                    var new_username = document.getElementById("usernameFieldR").value;
                    var new_email = document.getElementById("emailFieldR").value;
                    var new_password = document.getElementById("passwordFieldR").value;
                    var new_password2 = document.getElementById("passwordField2R").value;

                    showpanel(1);

                    $.ajax({
                        dataType: "json",
                        type: "POST",
                        url: "register",
                        data: {username: new_username, email: new_email, password: new_password, password2: new_password2},
                        timeout: 10000,
                        error: function (error, response, data) {
                            showpanel(2);

                            console.error(error);
                            console.error(response);
                            console.error(data);
                            done = true;
                            error = true;
                            submitting = false;

                            registerError.style.display = "block";
                            registerError.lastChild.innerText = response.substring(0, 1).toUpperCase() + response.substring(1, response.length);
                        },
                        success: function (data) {
                            done = true;
                            error = false;
                            submitting = false;
                            
                            if (data["registerstatus"] == "0") {
                                setTimeout(function () {
                                    console.log(data["message"]);
                                    window.location.href = "index.html";
                                }, 1000);
                            }
                            else {
                                setTimeout(function () {
                                    console.log(data["registerstatus"] + ": " + data["message"]);
                                    showpanel(2);
                                    
                                    registerError.style.display = "block";
                                    registerError.lastChild.innerText = data["message"];
                                }, 1000);
                            }
                        }
                    });
                }

                event.preventDefault();
            });
        });
    </script>
</html>